using DeviceWrappers.Core.Drivers;
using DeviceWrappers.Core.Connections;
using DeviceWrappers.Core.Interfaces;
using DeviceWrappers.Utils;

class Program
{
    public static async Task Main(string[] args)
    {
        Console.WriteLine("========================================");
        Console.WriteLine("  Device Wrappers Test Application");
        Console.WriteLine("========================================");
        Console.WriteLine();
        Console.WriteLine("Select device:");
        Console.WriteLine("1. Printer (Bixolon BK3-31)");
        Console.WriteLine("2. Camera (local camera)");
        Console.Write("Your choice: ");
        
        var choice = Console.ReadLine();
        
        if (choice == "1")
        {
            await TestPrinterAsync();
        }
        else if (choice == "2")
        {
            await TestCameraAsync();
        }
        else
        {
            Console.WriteLine("Invalid choice. Exiting.");
        }
    }

    private static async Task TestPrinterAsync()
    {
        Console.WriteLine();
        Console.WriteLine("=== PRINTER TEST ===");
        
        var profilePath = Path.Combine(AppContext.BaseDirectory, "printer.profile.json");
        if (!File.Exists(profilePath))
        {
            Console.WriteLine($"Profile not found: {profilePath}");
            return;
        }

        var profile = ProfileLoader.LoadPrinterProfile(profilePath);
        IPrinterDriver driver = DeviceFactory.ResolvePrinterDriver(profile);

        Console.Write("Enter printer IP (press Enter for 192.168.1.50): ");
        var ip = Console.ReadLine();
        if (string.IsNullOrWhiteSpace(ip)) ip = "192.168.1.50";
        
        var connection = new TcpConnection(ip, 9100);

        var printer = DeviceFactory.CreateDriverPrinter(
            connection,
            profile,
            driver,
            deviceName: $"{profile.Manufacturer} {profile.Model}");

        try
        {
            await printer.ConnectAsync();
            await printer.InitializeAsync();

            Console.WriteLine($"Connected to {profile.Manufacturer} {profile.Model}");
            Console.WriteLine("Sending print job...");
            
            await printer.PrintTextAsync("========================================");
            await printer.PrintTextAsync($"  {profile.Manufacturer} {profile.Model}");
            await printer.PrintTextAsync("  ESC/POS Test Print");
            await printer.PrintTextAsync("========================================");
            await printer.PrintTextAsync("");
            await printer.PrintTextAsync("Cyrillic: Привет, мир!");
            await printer.PrintTextAsync("Latin: Hello, World!");
            await printer.PrintTextAsync("Numbers: 1234567890");
            await printer.PrintTextAsync("");
            await printer.PrintTextAsync("Date/Time: " + DateTime.Now.ToString("dd.MM.yyyy HH:mm:ss"));
            await printer.PrintTextAsync("");
            await printer.PrintTextAsync("----------------------------------------");
            await printer.PrintTextAsync($"Code page: {profile.DefaultCodepage} (ESC t {profile.EscPosCodepage})");
            await printer.PrintTextAsync($"Cut: {(profile.SupportsCut ? "Yes" : "No")}");
            await printer.PrintTextAsync("========================================");

            Console.WriteLine("✓ Print job sent. Check the receipt on printer.");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Print error: {ex.Message}");
        }
        finally
        {
            await printer.DisconnectAsync();
            printer.Dispose();
        }
    }

    private static async Task TestCameraAsync()
    {
        Console.WriteLine();
        Console.WriteLine("=== CAMERA TEST ===");
        
        Console.WriteLine("Searching for available cameras...");
        var cameraIndices = DeviceFactory.EnumerateLocalCameraIndices(10);
        
        if (cameraIndices.Length == 0)
        {
            Console.WriteLine("No cameras found.");
            return;
        }

        Console.WriteLine($"Found cameras: {cameraIndices.Length}");
        for (int i = 0; i < cameraIndices.Length; i++)
        {
            Console.WriteLine($"  {i + 1}. Camera #{cameraIndices[i]} (index {cameraIndices[i]})");
        }
        
        Console.WriteLine();
        Console.Write($"Select camera (1-{cameraIndices.Length}): ");
        if (!int.TryParse(Console.ReadLine(), out int selection) || selection < 1 || selection > cameraIndices.Length)
        {
            Console.WriteLine("Invalid selection.");
            return;
        }

        var selectedIndex = cameraIndices[selection - 1];
        Console.WriteLine($"Selected camera #{selectedIndex}");

        ICamera camera = DeviceFactory.CreateLocalCamera(selectedIndex, $"Local Camera #{selectedIndex}");

        try
        {
            Console.WriteLine("Подключение к камере...");
            await camera.ConnectAsync();
            await camera.InitializeAsync();

            var info = await camera.GetDeviceInfoAsync();
            Console.WriteLine($"✓ Подключено к {info.DeviceName}");
            Console.WriteLine($"  Производитель: {info.Manufacturer}");
            Console.WriteLine($"  Модель: {info.Model}");
            
            var resolutions = await camera.GetSupportedResolutionsAsync();
            Console.WriteLine($"  Поддерживаемые разрешения: {string.Join(", ", resolutions.Select(r => r.ToString()))}");

            Console.WriteLine();
            Console.WriteLine("Захват кадра...");
            var frame = await camera.CaptureFrameAsync();
            
            var filename = $"camera_{selectedIndex}_{DateTime.Now:yyyyMMdd_HHmmss}.jpg";
            var filepath = Path.Combine(AppContext.BaseDirectory, filename);
            await camera.SaveFrameAsync(frame, filepath);

            Console.WriteLine($"✓ Кадр захвачен и сохранён:");
            Console.WriteLine($"  Файл: {filename}");
            Console.WriteLine($"  Путь: {filepath}");
            Console.WriteLine($"  Разрешение: {frame.Resolution}");
            Console.WriteLine($"  Формат: {frame.Format}");
            Console.WriteLine($"  Размер: {frame.Data.Length / 1024} KB");
            Console.WriteLine($"  Время: {frame.Timestamp:dd.MM.yyyy HH:mm:ss}");
            Console.WriteLine($"  Номер кадра: {frame.FrameNumber}");

            Console.WriteLine();
            Console.Write("Запустить видеопоток на 5 секунд? (y/n): ");
            if (Console.ReadLine()?.ToLower() == "y")
            {
                Console.WriteLine("Запуск потока...");
                int frameCount = 0;
                camera.FrameCaptured += (s, e) => {
                    frameCount++;
                    Console.WriteLine($"  Получен кадр #{e.Frame.FrameNumber}, размер: {e.Frame.Data.Length / 1024} KB");
                };

                await camera.StartStreamingAsync();
                await Task.Delay(5000);
                await camera.StopStreamingAsync();

                Console.WriteLine($"✓ Поток остановлен. Захвачено кадров: {frameCount}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ошибка работы с камерой: {ex.Message}");
            Console.WriteLine($"StackTrace: {ex.StackTrace}");
        }
        finally
        {
            await camera.DisconnectAsync();
            camera.Dispose();
        }
    }
}